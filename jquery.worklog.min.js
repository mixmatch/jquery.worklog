(function(d,c,a,e){var b=false;d.widget("mixmatch.worklog",{options:{width:"650px",height:"200px",background:"#FFF",format:"plain",title:{color:"#000",bold:true,underline:true,italics:false},fixMinHeight:false,template:false,autoSuggest:false,autoFocus:false,suggestLength:24,editable:true},_create:function(){this.nameSpace=this.eventNamespace.replace(/[.]/g,"");this.edited=false;this.lastWorklogEdit=null;this.inactiveInterval=[];this.autoSuggestLines=[];this.log=d.extend(true,{},this.options.template);this.checkInterval=null;this.currentLine=null;this.currentElem=null;this.showSuggest=false;this.lineHeight=15;this.$element=d(this.element);this.element.addClass(this.nameSpace);this.element.addClass(this.widgetName);this._setAutoSuggestLines();this._createTextArea()},_setOption:function(f,g){this._super(f,g)},_setOptions:function(f){this._super(f);this.refresh()},_blur:function(){this.$worklog.blur()},_constrain:function(f){},_destroy:function(){this.element.removeClass(this.nameSpace).text("")},_setAutoSuggestLines:function(){if(b){console.log("setAutoSuggestLines")}if(this.options.autoSuggest){var f=this;d.each(this.options.autoSuggest,function(g,h){f.autoSuggestLines.push(h.line)})}},_prevEditable:function(g){var f=d(g).prev(".editable");if(f.length){return f}else{if(d(g).prev().length){return this._prevEditable.apply(this,d(g).prev())}else{if(d(g).parent().length){return this._prevEditable.apply(this,d(g).parent())}else{return false}}}},_nextEditable:function(g){var f=d(g).next(".editable");if(f.length){return f}else{if(d(g).next().length){return this._nextEditable.apply(this,d(g).next())}else{if(d(g).parent().length){return this._nextEditable.apply(this,d(g).parent())}else{return false}}}},_getCaretOffsetHTML:function(h){var k=0;var l=h.ownerDocument||h.document;var j=l.defaultView||l.parentWindow;var f;var g=null;if(typeof j.getSelection!="undefined"){f=j.getSelection();if(f.rangeCount>0){var i=j.getSelection().getRangeAt(0);var m=i.cloneRange();m.selectNodeContents(h);m.setEnd(i.endContainer,i.endOffset);g=d("<div>").append(m.cloneContents()).html();k=g.length}}else{if((f=l.selection)&&f.type!="Control"){var o=f.createRange();var n=l.body.createTextRange();n.moveToElementText(h);n.setEndPoint("EndToEnd",o);k=n.text.length}}return k},_checkCursorPosition:function(){var l=this.focusedElem;var h=d(l);if(this.options.autoSuggest&&l!=null){var k=this._getCaretOffsetHTML(l);var g=h.html().replace(/(.*)<br>$/i,"$1").split("<br>");var f=h.html().substr(0,k).split("<br>").length-1;var j=parseInt(d(l).css("height"),10)/(g.length||1);var i;if(f!==this.currentLine||this.showSuggest){i=parseInt(d(l).css("padding-top"),10)+((f+1)*j);d(l).autocomplete("option","position",{my:"right top",at:"right top+"+i,collision:"none"}).autocomplete("search",g[f]);this.currentLine=f;this.showSuggest=false}}},_createTextArea:function(){if(b){console.log("createTextArea")}var j=this;var g="";var i=this.log||this.options.template;var f=d.extend(true,{},i);if(b){console.log(f)}var h=this.options;if(f){this.$element.css({width:h.width,height:h.height,background:h.background,"box-sizing":"border-box",padding:"2px","border-radius":"5px",resize:"none"}).append(d("<div>",{id:this.nameSpace+"header",css:{"margin-bottom":"5px",height:"18px",background:"rgba(0,0,0,0.15)","vertical-align":"bottom","border-radius":"4px",position:"relative"}}).append(d("<b>",{text:f.name+" Work Log ",css:{padding:"3px",position:"absolute",bottom:"0",left:"0"}})).append(d("<div>",{id:this.nameSpace+"headerFormat",css:{"float":"right"}}).append(d("<input>",{id:this.nameSpace+"boldCheck",checked:h.title.bold,type:"checkbox",change:function(){j.options.title.bold=d(this).is(":checked");j._setTitleFormat.apply(j)}})).append(d("<label>",{"for":this.nameSpace+"boldCheck",html:"<b>B</b>"})).append(d("<input>",{id:this.nameSpace+"italicsCheck",checked:h.title.italics,type:"checkbox",change:function(){h.title.italics=d(this).is(":checked");j._setTitleFormat.apply(j)}})).append(d("<label>",{"for":this.nameSpace+"italicsCheck",html:"<i>I</i>"})).append(d("<input>",{id:this.nameSpace+"underlineCheck",checked:h.title.underline,type:"checkbox",change:function(){h.title.underline=d(this).is(":checked");j._setTitleFormat.apply(j)}})).append(d("<label>",{"for":this.nameSpace+"underlineCheck",html:"<u>U</u>"})).append(d("<input>",{id:this.nameSpace+"titleColor",type:"color",val:h.title.color,css:{width:"16px",height:"16px","margin-left":"10px",padding:"0px 1px"},change:function(){h.title.color=d(this).val();j._setTitleFormat.apply(j)}})).buttonset())).append(d("<div>",{id:this.nameSpace+"body"}));d(".ui-button","#"+this.nameSpace+"header").css({height:"14px",width:"24px"});d(".ui-button-text","#"+this.nameSpace+"header").css({padding:"0px 2px",margin:"0px auto","font-size":"0.9em"});this.$worklogBody=d("#"+this.nameSpace+"body");d.each(f.sections,function(k,l){j.addSection.apply(j,[k,l])});if(f.sig!=null){j.$worklogBody.append(d("<div>",{id:j.nameSpace+"sig","class":j.options.editable?"editable":null}).data({type:"sig",base:j}).html("<b>"+f.sig+"</b>"))}}d(".editable").attr("contentEditable","true").css("white-space","pre").keydown(function(k){var t=d.ui.keyCode;var n=null;var o,p,m,q,l;if(k.keyCode==t.UP){k.stopImmediatePropagation();if(j.currentLine===0||j.currentLine==null){o=c.getSelection();p=a.createRange();m=o.getRangeAt(0).startContainer.parentElement;q=o.getRangeAt(0).startOffset;var r=j._prevEditable.apply(j,[j.focusedElem]);if(r){r.focus().css("background-color","rgba( 255, 255, 255, 0.7)");if(r.data("type")==="section"){l=r.contents().last()[0]}else{l=c.getSelection().getRangeAt(0).startContainer}if(b){console.log(l)}p.setStart(l,Math.min(q,l.length));p.collapse(true);setTimeout(function(){var v=c.getSelection();v.removeAllRanges();v.addRange(p)},1)}}}else{if(k.keyCode==t.DOWN){k.stopImmediatePropagation();var s=d(j.focusedElem).html().replace(/(.*)<br>$/i,"$1").split("<br>").length-1;if(j.currentLine===s||j.currentLine==null){o=c.getSelection();p=a.createRange();m=o.getRangeAt(0).startContainer.parentElement;q=o.getRangeAt(0).startOffset;var u=j._nextEditable.apply(j,[j.focusedElem]);if(u){u.focus().css("background-color","rgba( 255, 255, 255, 0.7)");l=c.getSelection().getRangeAt(0).startContainer;p.setStart(l,Math.min(q,l.length));p.collapse(true);setTimeout(function(){var v=c.getSelection();v.removeAllRanges();v.addRange(p)},1)}}}else{if(k.keyCode==t.ENTER){k.stopImmediatePropagation();if(d(this).data("type")==="section"){if(b){console.log(d(this).data("index"))}if(b){console.log(j.log.sections[d(this).data("index")])}if(b){console.log(j.log.sections[d(this).data("index")].length-2)}if(b){console.log(j.currentLine)}var s;if(j.log.firstLineTitle){s=j.log.sections[d(this).data("index")].length-2}else{s=j.log.sections[d(this).data("index")].length-1}if(j.currentLine!==s){a.execCommand("insertHTML",false,"<br><br>");o=c.getSelection();o.modify("move","backward","line")}else{a.execCommand("insertHTML",false,"<br><br>")}}return false}}}}).on("paste",function(m){if(b){console.log(m.originalEvent.clipboardData.getData("text/plain"))}var l=m.originalEvent;if(l&&l.clipboardData&&l.clipboardData.getData){var k=l.clipboardData.getData("text/plain");m.preventDefault();var n=k.replace(/\r?\n|\r/g,"<br>");if(b){console.log(n)}a.execCommand("insertHTML",false,n)}}).on("input",function(){var k=d(this).data();switch(k.type){case"title":j.log.sections[k.index][0]=this.innerText;break;case"section":var l=j._capitalizeFirst(d(this).html().replace(/(.*)<br>$/i,"$1").split("<br>"));if(j.log.firstLineTitle){j.log.sections[k.index]=[j.log.sections[k.index][0]].concat(l)}else{j.log.sections[k.index]=l}j.refreshSectionBar(k.index);break;case"sig":j.log.sig=this.innerText;break}j.showSuggest=true;j._trigger("change");j._trigger("edit")}).hover(function(k){if(k.type==="mouseenter"){d(this).css("background-color","rgba( 255, 255, 255, 0.7)")}else{if(d(j.focusedElem).attr("id")!=d(this).attr("id")){d(this).css("background-color","transparent")}}}).focus(function(){j.showSuggest=false;d(this).css("background-color","rgba( 255, 255, 255, 0.7)");j.focusedElem=this}).blur(function(){d(this).css("background-color","transparent");j.currentLine=null;j.focusedElem=null});if(h.autoSuggest){d(".autosuggest").autocomplete({source:function(o,l){var m=o.term.trim();if(b){console.log(m)}var k=[];var p=[];var n=[];d.each(j.autoSuggestLines,function(q,s){if(p.length>=h.suggestLength){if(b){console.log("Max suggestions reached")}return false}var r=s.toLowerCase().indexOf(m.toLowerCase());if(r===0){if(s.trim()===m){}else{p.push(s)}}else{if(r>0){n.push(s)}}});p=p.slice(0,h.suggestLength);n=n.slice(0,h.suggestLength-p.length);k=k.concat(p).concat(n);l(k)},focus:function(k,l){return false},select:function(k,l){if(b){console.log("Select")}if(b){console.log(l.item.value)}j.setCurrentLine(l.item.value,d(this).data().index);j._trigger("edit");return false},position:{my:"right top",at:"right bottom"},delay:0,autoFocus:this.options.autoFocus}).focus(function(){j.checkInterval=setInterval(function(){j._checkCursorPosition()},100)}).blur(function(){clearInterval(j.checkInterval)})}},_setTitleFormat:function(){if(b){console.log("Setting Title Format")}if(b){console.log(this.log)}var g=this.log;var h=this.options;var f=this.nameSpace;d.each(g.sections,function(j,k){if(g.firstLineTitle){switch(h.format){case"html":var i=k[0];if(h.title.italics){i="<i>"+i+"</i>"}if(h.title.underline){i="<u>"+i+"</u>"}if(h.title.bold){i="<b>"+i+"</b>"}d("#"+f+"title"+j).html('<font color="'+h.title.color+'">'+i+"</font>");break;case"plain":break}}})},_capitalizeFirst:function(g){if(Array.isArray(g)){var f=this;d.each(g,function(h,i){g[h]=f._capitalizeFirst(i)});return g}else{return g.charAt(0).toUpperCase()+g.slice(1)}},refresh:function(){this.$element.text("");this._createTextArea()},addSection:function(i,k){if(b){console.log("Adding Section")}var j=this;var g=this.log;var h=this.options;if(g.firstLineTitle){switch(h.format){case"html":var f=k.shift();if(h.title.italics){f="<i>"+f+"</i>"}if(h.title.underline){f="<u>"+f+"</u>"}if(h.title.bold){f="<b>"+f+"</b>"}j.$worklogBody.append(d("<div>",{id:j.nameSpace+"title"+i,"class":j.options.editable?"editable":null}).append(d('<font color="'+h.title.color+'">').html(f)).data({type:"title",index:i,base:j}));break;case"plain":break}}if(k.length){j.$worklogBody.append(d("<div>",{id:j.nameSpace+"section"+i+"bar",css:{"float":"left",width:"13px"}})).append(d("<div>",{id:j.nameSpace+"section"+i,"class":j.options.editable?"editable autosuggest":null,css:{overflow:"hidden"},data:{type:"section",index:i,base:j},html:k.join("<br>")+"<br>"})).append("<br>");j.refreshSectionBar(i)}if(!j.options.editable){d("#"+j.nameSpace+"section"+i+"bar").hide()}},refreshSection:function(k){if(b){console.log("Refreshing Section")}if(b){console.log(this.log.sections[k])}var i=this;var g=d.extend(true,{},this.log);var j=g.sections[k];var h=this.options;if(g.firstLineTitle){switch(h.format){case"html":var f=j.shift();if(h.title.italics){f="<i>"+f+"</i>"}if(h.title.underline){f="<u>"+f+"</u>"}if(h.title.bold){f="<b>"+f+"</b>"}d("#"+i.nameSpace+"title"+k).html(d('<font color="'+h.title.color+'">').html(f));break;case"plain":break}}if(j.length){d("#"+i.nameSpace+"section"+k).html(j.join("<br>")+"<br>");i.refreshSectionBar(k)}},refreshSectionBar:function(l){if(b){console.log("Refreshing Section Bar")}var j=this;var g=d.extend(true,{},this.log);var k=g.sections[l];d("#"+this.nameSpace+"section"+l+"bar").html("");var f=k.length;if(g.firstLineTitle){f--}for(var h=0;h<f;h++){if(b){console.log(parseInt(d("#"+this.nameSpace+"section"+l).css("height"),10)/f)}d("#"+this.nameSpace+"section"+l+"bar").append(d("<span>",{"class":"ui-icon ui-icon-close deleteLine",css:{cursor:"pointer",width:"13px",height:parseInt(d("#"+this.nameSpace+"section"+l).css("height"),10)/f},data:{section:l,line:h}}))}d("#"+this.nameSpace+"section"+l+"bar").css("height",d("#"+this.nameSpace+"section"+l).css("height"));d(".deleteLine").off("click").on("click",function(){var i=d(this).data();if(b){console.log(i)}j.removeLine(i.section,i.line);j._trigger("edit")})},findLineInSection:function(f,l,k,h){if(b){console.log("Finding Line In Section")}if(f===""){f="^$"}var g=new RegExp(f,"i");var i=this.log.sections[l];k=k!=null?k:0;h=h!=null?h:i.length;var j=false;if(typeof k==="string"){k=this.findLineInSection(k,l);if(k===false){return false}k++}if(typeof h==="string"){h=this.findLineInSection(h,l);if(h===false){return false}}d.each(i,function(m,n){if((g.test(n))&&(m>=k)&&(m<h)){j=m;return false}});return j},findLine:function(g,l,k,i){if(b){console.log("Finding Line")}var h=this;var f=this.log;var j=false;if(l!=null){j=this.findLineInSection(g,l,k,i)}else{d.each(this.log.sections,function(m,n){j=h.findLineInSection.apply(h,[g,m,k,i]);if(j!==false){l=m;return false}})}return j!==false?{section:l,line:j}:false},addLine:function(f,i,h){if(b){console.log("Adding Line")}f=this._capitalizeFirst(f);i=i!=null?i:this.log.sections.length-1;var g=this.log.sections[i];if(h==null){if(g[g.length-1]===""){g.pop()}h=g.length}if(Array.isArray(f)){if(b){console.log("Adding Line")}g=g.slice(0,h).concat(f).concat(g.slice(h))}else{g.splice(h,0,f)}this.log.sections[i]=g;this.refreshSection(i);this._trigger("change")},setLine:function(h,f,g){if(b){console.log("Setting Line")}f=this._capitalizeFirst(f);this.log.sections[g][h]=f;this.refreshSection(g);this._trigger("change")},setCurrentLine:function(f,g){if(b){console.log("Setting Current Line")}var h=this.currentLine;if(this.log.firstLineTitle){h++}this.setLine.apply(this,[h,f,g])},replace:function(h,f,l,n,j){if(b){console.log("Replacing")}if(b){console.log(f)}var k=this.findLine(h,l,n,j);var i;var g=this;if(b){console.log(k)}if(k!==false){var o=new RegExp(h,"i");if(b){console.log(this.log.sections[k.section][k.line])}var m=this.log.sections[k.section][k.line];if(Array.isArray(f)){i=m.replace(o,f.shift());this.setLine(k.line,i,k.section);d.each(f,function(p,q){g.addLine(q,k.section)})}else{i=m.replace(o,f);this.setLine(k.line,i,k.section)}return k}else{return false}},replaceLine:function(f,g,k,j,h){if(b){console.log("Replacing Line")}var i=this.findLine(f,k,j,h);if(i!==false){this.setLine(i.line,g,i.section);return i}else{return false}},removeLine:function(i,g){if(b){console.log("Removing Line")}if(b){console.log(i)}if(b){console.log(g)}var h=this.log.sections[i];var f=h.length;if(this.log.firstLineTitle){g++;f--}if(f>1){this.log.sections[i].splice(g,1)}else{this.log.sections[i][g]=""}this.refreshSection(i)},toArray:function(j){if(b){console.log("toArray")}var g=[];var f=d.extend(true,{},this.log);var i=this.options;if(j==null){d.each(f.sections,function(l,m){if(f.firstLineTitle){switch(i.format){case"html":var k=m.shift();if(i.title.italics){k="<i>"+k+"</i>"}if(i.title.underline){k="<u>"+k+"</u>"}if(i.title.bold){k="<b>"+k+"</b>"}g.push('<font color="'+i.title.color+'">'+k+"</font>");break;case"plain":break}}if(m.length){d.merge(g,m);g.push("")}});if(f.sig!=null){g.push("<b>"+f.sig+"</b>")}}else{if(f.firstLineTitle){switch(i.format){case"html":var h=f.sections[j].shift();if(i.title.italics){h="<i>"+h+"</i>"}if(i.title.underline){h="<u>"+h+"</u>"}if(i.title.bold){h="<b>"+h+"</b>"}g.push('<font color="'+i.title.color+'">'+h+"</font>");break;case"plain":break}}if(f.sections[j].length){d.merge(g,f.sections[j])}}return g},value:function(f){if(b){console.log("value")}return this.toArray(f).join("\n")},logObj:function(){return this.log}})})(jQuery,window,document);