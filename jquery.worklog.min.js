!function(t,o,e,i){function n(o,e){this.element=o,this.options=t.extend({},a,e),this._defaults=a,this._name=r,this.autoSuggestLines=[],this.$worklog=null,this.checkInterval=null,this.currLine=1,this.lineHeight=15,this.init()}var s=!0,r="worklog",a={width:"650px",height:"200px",background:"#FFF",format:"plain",titleColor:"#000",fixMinHeight:!0,template:!1,autoSuggest:!1,autoFocus:!1,suggestLength:24}
t.extend(n.prototype,{init:function(){s&&console.log("init"),this.setAutoSuggestLines(),this.createTextArea(),this.loadLog(),this.lineHeight=parseInt(this.$worklog.css("height"),10)/(this.$worklog.data("linesArray").length||1),s&&console.log(this)},setAutoSuggestLines:function(){if(s&&console.log("setAutoSuggestLines"),this.options.autoSuggest){var o=this
t.each(this.options.autoSuggest,function(t,e){o.autoSuggestLines.push(e.line)})}},checkCursorPosition:function(t){if(s&&console.log("checkCursorPosition"),null!=t.$worklog){var o,e=t.$worklog[0],i=e.value.split("\n"),n=e.value.substr(0,e.selectionStart).split("\n").length-1
return n!==t.currLine?(s&&console.log(n),t.currLine=n,o=parseInt(t.$worklog.css("padding-top"),10)+(t.currLine+1)*t.lineHeight,t.options.autoSuggest&&t.$worklog.autocomplete("option","position",{my:"right top",at:"right top+"+o}).autocomplete("search",i[n])):i[n]!==t.$worklog.data("linesArray")[n]&&(s&&console.log(i[n]),t.$worklog.data("linesArray",e.value.split("\n")),o=parseInt(t.$worklog.css("padding-top"),10)+(t.currLine+1)*t.lineHeight,console.log(o),t.options.autoSuggest&&t.$worklog.autocomplete("option","position",{my:"right top",at:"right top+"+o}).autocomplete("search",i[n])),n}return!1},createTextArea:function(){s&&console.log("createTextArea")
var o=this,e=""
this.options.template&&(e+="<b>"+this.options.template.name+"</b><br>"),t(this.element).html(e+'<textarea class="worklog" autofocus="false"></textarea>'),this.$worklog=t("textarea",t(this.element)),this.$worklog.data("linesArray",[]),this.$worklog.css({width:this.options.width,height:this.options.height,background:this.options.background,resize:"none"}).attr({minWidth:this.options.width}).autogrow({vertical:!0,horizontal:!0,fixMinHeight:this.fixMinHeight}).focus(function(){o.checkInterval=setInterval(o.checkCursorPosition,250,o)}).blur(function(){clearInterval(o.checkInterval)}).keydown(function(o){var e=t.ui.keyCode;(o.keyCode==e.UP||o.keyCode==e.DOWN)&&o.stopImmediatePropagation()}).focus(),this.options.autoSuggest&&this.$worklog.autocomplete({source:function(e,i){var n=e.term.trim()
console.log(n)
var r=[],a=[],l=[]
t.each(o.autoSuggestLines,function(t,e){if(a.length>=o.options.suggestLength)return s&&console.log("Max suggestions reached"),!1
var i=e.toLowerCase().indexOf(n.toLowerCase())
0===i?e.trim()===n?a.unshift(e):a.push(e):i>0&&l.push(e)}),r=r.concat(a.slice(0,o.options.suggestLength)).concat(l.slice(0,o.options.suggestLength-r.length)),1===r.length&&r[0].trim()===n&&(r=[]),i(r)},focus:function(){return!1},select:function(t,e){return console.log("Select"),console.log(e.item.value),o.setCurrentLine(e.item.value,o),!1},position:{my:"right top",at:"right bottom"},delay:0,autoFocus:this.options.autoFocus})},loadLog:function(){s&&console.log("loadLog")
var o=this,e="",i=this.options.template
i&&(t.each(i.sections,function(t,n){if(i.firstLineTitle)switch(o.options.format){case"html":e+='<font color="'+o.options.titleColor+'"><b><u>'+n.shift()+"</u></b></font>\n"
break
case"plain":}n.length&&(e+=n.join("\n")+"\n\n")}),null!=i.sig&&(e+="<b>"+i.sig+"</b>"),this.$worklog.val(e),this.$worklog.data("linesArray",e.split("\n")),this.$worklog.trigger("update.autogrow"))},setCurrentLine:function(t,o){var e=o.$worklog.data("linesArray")
e[o.currLine]=t
var i=o.$worklog[0].selectionStart
o.$worklog.val(e.join("\n"))
var n=i+o.$worklog.val().substring(i).indexOf("\n")
o.$worklog[0].setSelectionRange(n,n)}}),t.fn[r]=function(o){var e=arguments
if(o===i||"object"==typeof o)return this.each(function(){t.data(this,"plugin_"+r)||t.data(this,"plugin_"+r,new n(this,o))})
if("string"==typeof o&&"_"!==o[0]&&"init"!==o){var s
return this.each(function(){var i=t.data(this,"plugin_"+r)
i instanceof n&&"function"==typeof i[o]&&(s=i[o].apply(i,Array.prototype.slice.call(e,1))),"destroy"===o&&t.data(this,"plugin_"+r,null)}),s!==i?s:this}}}(jQuery,window,document)