(function(d,k,l,n){d.widget("mixmatch.worklog",{options:{width:"650px",height:"200px",background:"#FFF",format:"plain",title:{color:"#000",bold:!0,underline:!0,italics:!1},fixMinHeight:!1,template:!1,autoSuggest:!1,autoFocus:!1,suggestLength:24},_create:function(){this.nameSpace=this.eventNamespace.replace(/[.]/g,"");this.edited=!1;this.lastWorklogEdit=null;this.inactiveInterval=[];this.autoSuggestLines=[];this.log=d.extend(!0,{},this.options.template);this.currentElem=this.currentLine=this.checkInterval=
null;this.showSuggest=!1;this.lineHeight=15;this.$element=d(this.element);this.element.addClass(this.nameSpace);this.element.addClass(this.widgetName);this._setAutoSuggestLines();this._createTextArea()},_setOption:function(a,c){this._super(a,c)},_setOptions:function(a){this._super(a);this.refresh()},_blur:function(){this.$worklog.blur()},_constrain:function(a){},_destroy:function(){this.element.removeClass(this.nameSpace).text("")},_setAutoSuggestLines:function(){console.log("setAutoSuggestLines");
if(this.options.autoSuggest){var a=this;d.each(this.options.autoSuggest,function(c,b){a.autoSuggestLines.push(b.line)})}},_prevEditable:function(a){var c=d(a).prev(".editable");return c.length?c:d(a).prev().length?this._prevEditable.apply(this,d(a).prev()):d(a).parent().length?this._prevEditable.apply(this,d(a).parent()):!1},_nextEditable:function(a){var c=d(a).next(".editable");return c.length?c:d(a).next().length?this._nextEditable.apply(this,d(a).next()):d(a).parent().length?this._nextEditable.apply(this,
d(a).parent()):!1},_getCaretOffsetHTML:function(a){var c=0,b=a.ownerDocument||a.document,e=b.defaultView||b.parentWindow,g,f=null;"undefined"!=typeof e.getSelection?(g=e.getSelection(),0<g.rangeCount&&(b=e.getSelection().getRangeAt(0),c=b.cloneRange(),c.selectNodeContents(a),c.setEnd(b.endContainer,b.endOffset),f=d("<div>").append(c.cloneContents()).html(),c=f.length)):(g=b.selection)&&"Control"!=g.type&&(c=g.createRange(),b=b.body.createTextRange(),b.moveToElementText(a),b.setEndPoint("EndToEnd",
c),c=b.text.length);return c},_checkCursorPosition:function(){var a=this.focusedElem,c=d(a);if(this.options.autoSuggest&&null!=a){var b=this._getCaretOffsetHTML(a),e=c.html().replace(/(.*)<br>$/i,"$1").split("<br>"),c=c.html().substr(0,b).split("<br>").length-1,b=parseInt(d(a).css("height"),10)/(e.length||1);if(c!==this.currentLine||this.showSuggest)b=parseInt(d(a).css("padding-top"),10)+(c+1)*b,d(a).autocomplete("option","position",{my:"right top",at:"right top+"+b,collision:"none"}).autocomplete("search",
e[c]),this.currentLine=c,this.showSuggest=!1}},_createTextArea:function(){console.log("createTextArea");var a=this,c=d.extend(!0,{},this.log||this.options.template);console.log(c);var b=this.options;c&&(this.$element.css({width:b.width,height:b.height,background:b.background,padding:"2px",resize:"none"}).append(d("<div>",{id:this.nameSpace+"header",css:{"margin-bottom":"10px"}}).append(d("<b>",{text:c.name+" "})).append(d("<div>",{id:this.nameSpace+"headerFormat",css:{"float":"right"}}).append(d("<input>",
{id:this.nameSpace+"boldCheck",checked:b.title.bold,type:"checkbox",change:function(){a.options.title.bold=d(this).is(":checked");a._setTitleFormat.apply(a)}})).append(d("<label>",{"for":this.nameSpace+"boldCheck",html:"<b>B</b>"})).append(d("<input>",{id:this.nameSpace+"italicsCheck",checked:b.title.italics,type:"checkbox",change:function(){b.title.italics=d(this).is(":checked");a._setTitleFormat.apply(a)}})).append(d("<label>",{"for":this.nameSpace+"italicsCheck",html:"<i>I</i>"})).append(d("<input>",
{id:this.nameSpace+"underlineCheck",checked:b.title.underline,type:"checkbox",change:function(){b.title.underline=d(this).is(":checked");a._setTitleFormat.apply(a)}})).append(d("<label>",{"for":this.nameSpace+"underlineCheck",html:"<u>U</u>"})).append(d("<input>",{id:this.nameSpace+"titleColor",type:"color",val:b.title.color,css:{width:"16px",height:"16px","margin-left":"10px",padding:"0px 1px"},change:function(){b.title.color=d(this).val();a._setTitleFormat.apply(a)}})).buttonset())).append(d("<div>",
{id:this.nameSpace+"body"})),d(".ui-button","#"+this.nameSpace+"header").css({height:"14px",width:"24px"}),d(".ui-button-text","#"+this.nameSpace+"header").css({padding:"0px 2px",margin:"0px auto","font-size":"0.9em"}),this.$worklogBody=d("#"+this.nameSpace+"body"),d.each(c.sections,function(b,c){a.addSection.apply(a,[b,c])}),null!=c.sig&&a.$worklogBody.append(d("<div>",{id:a.nameSpace+"sig","class":"editable"}).data({type:"sig",base:a}).html("<b>"+c.sig+"</b>")));d(".editable").attr("contentEditable",
"true").css("white-space","pre").keydown(function(b){var c=d.ui.keyCode,f;if(b.keyCode==c.UP){if(b.stopImmediatePropagation(),0===a.currentLine||null==a.currentLine)if(b=k.getSelection(),f=l.createRange(),b.getRangeAt(0),b=b.getRangeAt(0).startOffset,c=a._prevEditable.apply(a,[a.focusedElem]))c.focus().css("background-color","rgba( 255, 255, 255, 0.7)"),c="section"===c.data("type")?c.contents().last()[0]:k.getSelection().getRangeAt(0).startContainer,console.log(c),f.setStart(c,Math.min(b,c.length)),
f.collapse(!0),setTimeout(function(){var a=k.getSelection();a.removeAllRanges();a.addRange(f)},1)}else if(b.keyCode==c.DOWN){if(b.stopImmediatePropagation(),b=d(a.focusedElem).html().replace(/(.*)<br>$/i,"$1").split("<br>").length-1,a.currentLine===b||null==a.currentLine)if(b=k.getSelection(),f=l.createRange(),b.getRangeAt(0),b=b.getRangeAt(0).startOffset,c=a._nextEditable.apply(a,[a.focusedElem]))c.focus().css("background-color","rgba( 255, 255, 255, 0.7)"),c=k.getSelection().getRangeAt(0).startContainer,
f.setStart(c,Math.min(b,c.length)),f.collapse(!0),setTimeout(function(){var a=k.getSelection();a.removeAllRanges();a.addRange(f)},1)}else if(b.keyCode==c.ENTER)return b.stopImmediatePropagation(),"section"===d(this).data("type")&&(console.log(d(this).data("index")),console.log(a.log.sections[d(this).data("index")]),console.log(a.log.sections[d(this).data("index")].length-2),console.log(a.currentLine),a.currentLine!==a.log.sections[d(this).data("index")].length-2?(l.execCommand("insertHTML",!1,"<br><br>"),
b=k.getSelection(),b.modify("move","backward","line")):l.execCommand("insertHTML",!1,"<br><br>")),!1}).on("input",function(){var b=d(this).data();switch(b.type){case "title":a.log.sections[b.index][0]=this.innerText;break;case "section":d(this).find("*:not(br)").contents().unwrap();var c=a._capitalizeFirst(d(this).html().replace(/(.*)<br>$/i,"$1").split("<br>"));a.log.sections[b.index]=a.log.firstLineTitle?[a.log.sections[b.index][0]].concat(c):c;a.refreshSectionBar(b.index);break;case "sig":a.log.sig=
this.innerText}a.showSuggest=!0;a._trigger("change")}).hover(function(b){"mouseenter"===b.type?d(this).css("background-color","rgba( 255, 255, 255, 0.7)"):d(a.focusedElem).attr("id")!=d(this).attr("id")&&d(this).css("background-color","transparent")}).focus(function(){a.showSuggest=!1;d(this).css("background-color","rgba( 255, 255, 255, 0.7)");a.focusedElem=this}).blur(function(){d(this).css("background-color","transparent");a.currentLine=null;a.focusedElem=null});b.autoSuggest&&d(".autosuggest").autocomplete({source:function(c,
g){var f=c.term.trim();console.log(f);var m=[],h=[],k=[];d.each(a.autoSuggestLines,function(a,c){if(h.length>=b.suggestLength)return console.log("Max suggestions reached"),!1;var d=c.toLowerCase().indexOf(f.toLowerCase());0===d?c.trim()!==f&&h.push(c):0<d&&k.push(c)});h=h.slice(0,b.suggestLength);k=k.slice(0,b.suggestLength-h.length);m=m.concat(h).concat(k);g(m)},focus:function(a,b){return!1},select:function(b,c){console.log("Select");console.log(c.item.value);a.setCurrentLine(c.item.value,d(this).data().index);
return!1},position:{my:"right top",at:"right bottom"},delay:0,autoFocus:this.options.autoFocus}).focus(function(){a.checkInterval=setInterval(function(){a._checkCursorPosition()},100)}).blur(function(){clearInterval(a.checkInterval)})},_setTitleFormat:function(){console.log("Setting Title Format");console.log(this.log);var a=this.log,c=this.options,b=this.nameSpace;d.each(a.sections,function(e,g){if(a.firstLineTitle)switch(c.format){case "html":var f=g[0];c.title.italics&&(f="<i>"+f+"</i>");c.title.underline&&
(f="<u>"+f+"</u>");c.title.bold&&(f="<b>"+f+"</b>");d("#"+b+"title"+e).html('<font color="'+c.title.color+'">'+f+"</font>")}})},_capitalizeFirst:function(a){if(Array.isArray(a)){var c=this;d.each(a,function(b,d){a[b]=c._capitalizeFirst(d)});return a}return a.charAt(0).toUpperCase()+a.slice(1)},refresh:function(){this.$element.text("");this._createTextArea()},addSection:function(a,c){console.log("Adding Section");var b=this.options;if(this.log.firstLineTitle)switch(b.format){case "html":var e=c.shift();
b.title.italics&&(e="<i>"+e+"</i>");b.title.underline&&(e="<u>"+e+"</u>");b.title.bold&&(e="<b>"+e+"</b>");this.$worklogBody.append(d("<div>",{id:this.nameSpace+"title"+a,"class":"editable"}).append(d('<font color="'+b.title.color+'">').html(e)).data({type:"title",index:a,base:this}))}c.length&&(this.$worklogBody.append(d("<div>",{id:this.nameSpace+"section"+a+"bar",css:{"float":"left",width:"13px"}})).append(d("<div>",{id:this.nameSpace+"section"+a,"class":"editable autosuggest",css:{overflow:"hidden"},
data:{type:"section",index:a,base:this},html:c.join("<br>")+"<br>"})).append("<br>"),this.refreshSectionBar(a))},refreshSection:function(a){console.log("Refreshing Section");console.log(this.log.sections[a]);var c=d.extend(!0,{},this.log),b=c.sections[a],e=this.options;if(c.firstLineTitle)switch(e.format){case "html":c=b.shift(),e.title.italics&&(c="<i>"+c+"</i>"),e.title.underline&&(c="<u>"+c+"</u>"),e.title.bold&&(c="<b>"+c+"</b>"),d("#"+this.nameSpace+"title"+a).html(d('<font color="'+e.title.color+
'">').html(c))}b.length&&(d("#"+this.nameSpace+"section"+a).html(b.join("<br>")+"<br>"),this.refreshSectionBar(a))},refreshSectionBar:function(a){var c=this,b=d.extend(!0,{},this.log),e=b.sections[a];d("#"+this.nameSpace+"section"+a+"bar").html("");e=e.length;b.firstLineTitle&&e--;for(b=0;b<e;b++)console.log(parseInt(d("#"+this.nameSpace+"section"+a).css("height"),10)/e),d("#"+this.nameSpace+"section"+a+"bar").append(d("<span>",{"class":"ui-icon ui-icon-close deleteLine",css:{cursor:"pointer",width:"13px",
height:parseInt(d("#"+this.nameSpace+"section"+a).css("height"),10)/e},data:{section:a,line:b}}));d("#"+this.nameSpace+"section"+a+"bar").css("height",d("#"+this.nameSpace+"section"+a).css("height"));d(".deleteLine").off("click").on("click",function(){var a=d(this).data();console.log(a);c.removeLine(a.section,a.line)})},findLineInSection:function(a,c,b,e){console.log("Finding Line In Section");""===a&&(a="^$");var g=new RegExp(a,"i");a=this.log.sections[c];b=null!=b?b:0;e=null!=e?e:a.length;var f=
!1;if("string"===typeof b){b=this.findLineInSection(b,c);if(!1===b)return!1;b++}if("string"===typeof e&&(e=this.findLineInSection(e,c),!1===e))return!1;d.each(a,function(a,c){if(g.test(c)&&a>=b&&a<e)return f=a,!1});return f},findLine:function(a,c,b,e){console.log("Finding Line");var g=this,f=!1;null!=c?f=this.findLineInSection(a,c,b,e):d.each(this.log.sections,function(d,h){f=g.findLineInSection.apply(g,[a,d,b,e]);if(!1!==f)return c=d,!1});return!1!==f?{section:c,line:f}:!1},addLine:function(a,c,
b){console.log("Adding Line");a=this._capitalizeFirst(a);c=null!=c?c:this.log.sections.length-1;var d=this.log.sections[c];null==b&&(""===d[d.length-1]&&d.pop(),b=d.length);Array.isArray(a)?(console.log("Adding Line"),d=d.slice(0,b).concat(a).concat(d.slice(b))):d.splice(b,0,a);this.log.sections[c]=d;this.refreshSection(c);this._trigger("change")},setLine:function(a,c,b){console.log("Setting Line");c=this._capitalizeFirst(c);this.log.sections[b][a]=c;this.refreshSection(b);this._trigger("change")},
setCurrentLine:function(a,c){console.log("Setting Current Line");var b=this.currentLine;this.log.firstLineTitle&&b++;this.setLine.apply(this,[b,a,c])},replace:function(a,c,b,d,g){console.log("Replacing");b=this.findLine(a,b,d,g);console.log(b);return!1!==b?(a=new RegExp(a,"i"),console.log(this.log.sections[b.section][b.line]),c=this.log.sections[b.section][b.line].replace(a,c),this.setLine(b.line,c,b.section),b):!1},replaceLine:function(a,c,b,d,g){console.log("Replacing Line");a=this.findLine(a,b,
d,g);return!1!==a?(this.setLine(a.line,c,a.section),a):!1},removeLine:function(a,c){console.log("Removing Line");console.log(a);console.log(c);var b=this.log.sections[a].length;this.log.firstLineTitle&&(c++,b--);1<b?this.log.sections[a].splice(c,1):this.log.sections[a][c]="";this.refreshSection(a)},toArray:function(a){console.log("toArray");var c=[],b=d.extend(!0,{},this.log),e=this.options;if(null==a)d.each(b.sections,function(a,g){if(b.firstLineTitle)switch(e.format){case "html":var h=g.shift();
e.title.italics&&(h="<i>"+h+"</i>");e.title.underline&&(h="<u>"+h+"</u>");e.title.bold&&(h="<b>"+h+"</b>");c.push('<font color="'+e.title.color+'">'+h+"</font>")}g.length&&(d.merge(c,g),c.push(""))}),null!=b.sig&&c.push("<b>"+b.sig+"</b>");else{if(b.firstLineTitle)switch(e.format){case "html":var g=b.sections[a].shift();e.title.italics&&(g="<i>"+g+"</i>");e.title.underline&&(g="<u>"+g+"</u>");e.title.bold&&(g="<b>"+g+"</b>");c.push('<font color="'+e.title.color+'">'+g+"</font>")}b.sections[a].length&&
d.merge(c,b.sections[a])}return c},value:function(a){console.log("value");return this.toArray(a).join("\n")},logObj:function(){return this.log}})})(jQuery,window,document);
