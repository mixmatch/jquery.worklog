(function(e,k,l,n){e.widget("mixmatch.worklog",{options:{width:"650px",height:"200px",background:"#FFF",format:"plain",title:{color:"#000",bold:!0,underline:!0,italics:!1},fixMinHeight:!1,template:!1,autoSuggest:!1,autoFocus:!1,suggestLength:24},_create:function(){this.nameSpace=this.eventNamespace.replace(/[.]/g,"");this.edited=!1;this.lastWorklogEdit=null;this.inactiveInterval=[];this.autoSuggestLines=[];this.log=e.extend(!0,{},this.options.template);this.currentElem=this.currentLine=this.checkInterval=
null;this.showSuggest=!1;this.lineHeight=15;this.$element=e(this.element);this.element.addClass(this.nameSpace);this.element.addClass(this.widgetName);this._setAutoSuggestLines();this._createTextArea()},_setOption:function(a,b){this._super(a,b)},_setOptions:function(a){this._super(a);this.refresh()},_blur:function(){this.$worklog.blur()},_constrain:function(a){},_destroy:function(){this.element.removeClass(this.nameSpace).text("")},_setAutoSuggestLines:function(){console.log("setAutoSuggestLines");
if(this.options.autoSuggest){var a=this;e.each(this.options.autoSuggest,function(b,c){a.autoSuggestLines.push(c.line)})}},_prevEditable:function(a){var b=e(a).prev(".editable");return b.length?b:e(a).prev().length?this._prevEditable.apply(this,e(a).prev()):e(a).parent().length?this._prevEditable.apply(this,e(a).parent()):!1},_nextEditable:function(a){var b=e(a).next(".editable");return b.length?b:e(a).next().length?this._nextEditable.apply(this,e(a).next()):e(a).parent().length?this._nextEditable.apply(this,
e(a).parent()):!1},_getCaretOffsetHTML:function(a){var b=0,c=a.ownerDocument||a.document,d=c.defaultView||c.parentWindow,g,f=null;"undefined"!=typeof d.getSelection?(g=d.getSelection(),0<g.rangeCount&&(c=d.getSelection().getRangeAt(0),b=c.cloneRange(),b.selectNodeContents(a),b.setEnd(c.endContainer,c.endOffset),f=e("<div>").append(b.cloneContents()).html(),b=f.length)):(g=c.selection)&&"Control"!=g.type&&(b=g.createRange(),c=c.body.createTextRange(),c.moveToElementText(a),c.setEndPoint("EndToEnd",
b),b=c.text.length);return b},_checkCursorPosition:function(){var a=this.focusedElem,b=e(a);if(this.options.autoSuggest&&null!=a){var c=this._getCaretOffsetHTML(a),d=b.html().replace(/(.*)<br>$/i,"$1").split("<br>"),b=b.html().substr(0,c).split("<br>").length-1,c=parseInt(e(a).css("height"),10)/(d.length||1);if(b!==this.currentLine||this.showSuggest)c=parseInt(e(a).css("padding-top"),10)+(b+1)*c,e(a).autocomplete("option","position",{my:"right top",at:"right top+"+c,collision:"none"}).autocomplete("search",
d[b]),this.currentLine=b,this.showSuggest=!1}},_createTextArea:function(){console.log("createTextArea");var a=this,b=e.extend(!0,{},this.log||this.options.template);console.log(b);var c=this.options;b&&(this.$element.css({width:c.width,height:c.height,background:c.background,padding:"2px","border-radius":"5px",resize:"none"}).append(e("<div>",{id:this.nameSpace+"header",css:{"margin-bottom":"5px",height:"18px",background:"rgba(0,0,0,0.15)","vertical-align":"bottom","border-radius":"4px",position:"relative"}}).append(e("<b>",
{text:b.name+" Work Log ",css:{padding:"3px",position:"absolute",bottom:"0",left:"0"}})).append(e("<div>",{id:this.nameSpace+"headerFormat",css:{"float":"right"}}).append(e("<input>",{id:this.nameSpace+"boldCheck",checked:c.title.bold,type:"checkbox",change:function(){a.options.title.bold=e(this).is(":checked");a._setTitleFormat.apply(a)}})).append(e("<label>",{"for":this.nameSpace+"boldCheck",html:"<b>B</b>"})).append(e("<input>",{id:this.nameSpace+"italicsCheck",checked:c.title.italics,type:"checkbox",
change:function(){c.title.italics=e(this).is(":checked");a._setTitleFormat.apply(a)}})).append(e("<label>",{"for":this.nameSpace+"italicsCheck",html:"<i>I</i>"})).append(e("<input>",{id:this.nameSpace+"underlineCheck",checked:c.title.underline,type:"checkbox",change:function(){c.title.underline=e(this).is(":checked");a._setTitleFormat.apply(a)}})).append(e("<label>",{"for":this.nameSpace+"underlineCheck",html:"<u>U</u>"})).append(e("<input>",{id:this.nameSpace+"titleColor",type:"color",val:c.title.color,
css:{width:"16px",height:"16px","margin-left":"10px",padding:"0px 1px"},change:function(){c.title.color=e(this).val();a._setTitleFormat.apply(a)}})).buttonset())).append(e("<div>",{id:this.nameSpace+"body"})),e(".ui-button","#"+this.nameSpace+"header").css({height:"14px",width:"24px"}),e(".ui-button-text","#"+this.nameSpace+"header").css({padding:"0px 2px",margin:"0px auto","font-size":"0.9em"}),this.$worklogBody=e("#"+this.nameSpace+"body"),e.each(b.sections,function(d,b){a.addSection.apply(a,[d,
b])}),null!=b.sig&&a.$worklogBody.append(e("<div>",{id:a.nameSpace+"sig","class":"editable"}).data({type:"sig",base:a}).html("<b>"+b.sig+"</b>")));e(".editable").attr("contentEditable","true").css("white-space","pre").keydown(function(d){var b=e.ui.keyCode,c;if(d.keyCode==b.UP){if(d.stopImmediatePropagation(),0===a.currentLine||null==a.currentLine)if(d=k.getSelection(),c=l.createRange(),d.getRangeAt(0),d=d.getRangeAt(0).startOffset,b=a._prevEditable.apply(a,[a.focusedElem]))b.focus().css("background-color",
"rgba( 255, 255, 255, 0.7)"),b="section"===b.data("type")?b.contents().last()[0]:k.getSelection().getRangeAt(0).startContainer,console.log(b),c.setStart(b,Math.min(d,b.length)),c.collapse(!0),setTimeout(function(){var a=k.getSelection();a.removeAllRanges();a.addRange(c)},1)}else if(d.keyCode==b.DOWN){if(d.stopImmediatePropagation(),d=e(a.focusedElem).html().replace(/(.*)<br>$/i,"$1").split("<br>").length-1,a.currentLine===d||null==a.currentLine)if(d=k.getSelection(),c=l.createRange(),d.getRangeAt(0),
d=d.getRangeAt(0).startOffset,b=a._nextEditable.apply(a,[a.focusedElem]))b.focus().css("background-color","rgba( 255, 255, 255, 0.7)"),b=k.getSelection().getRangeAt(0).startContainer,c.setStart(b,Math.min(d,b.length)),c.collapse(!0),setTimeout(function(){var a=k.getSelection();a.removeAllRanges();a.addRange(c)},1)}else if(d.keyCode==b.ENTER)return d.stopImmediatePropagation(),"section"===e(this).data("type")&&(console.log(e(this).data("index")),console.log(a.log.sections[e(this).data("index")]),console.log(a.log.sections[e(this).data("index")].length-
2),console.log(a.currentLine),a.currentLine!==a.log.sections[e(this).data("index")].length-2?(l.execCommand("insertHTML",!1,"<br><br>"),d=k.getSelection(),d.modify("move","backward","line")):l.execCommand("insertHTML",!1,"<br><br>")),!1}).on("paste",function(a){console.log(a.originalEvent.clipboardData.getData("text/plain"));var b=a.originalEvent;b&&b.clipboardData&&b.clipboardData.getData&&(b=b.clipboardData.getData("text/plain"),a.preventDefault(),a=b.replace(/\r?\n|\r/g,"<br>"),console.log(a),
l.execCommand("insertHTML",!1,a))}).on("input",function(){var b=e(this).data();switch(b.type){case "title":a.log.sections[b.index][0]=this.innerText;break;case "section":var c=a._capitalizeFirst(e(this).html().replace(/(.*)<br>$/i,"$1").split("<br>"));a.log.sections[b.index]=a.log.firstLineTitle?[a.log.sections[b.index][0]].concat(c):c;a.refreshSectionBar(b.index);break;case "sig":a.log.sig=this.innerText}a.showSuggest=!0;a._trigger("change")}).hover(function(b){"mouseenter"===b.type?e(this).css("background-color",
"rgba( 255, 255, 255, 0.7)"):e(a.focusedElem).attr("id")!=e(this).attr("id")&&e(this).css("background-color","transparent")}).focus(function(){a.showSuggest=!1;e(this).css("background-color","rgba( 255, 255, 255, 0.7)");a.focusedElem=this}).blur(function(){e(this).css("background-color","transparent");a.currentLine=null;a.focusedElem=null});c.autoSuggest&&e(".autosuggest").autocomplete({source:function(b,g){var f=b.term.trim();console.log(f);var m=[],h=[],k=[];e.each(a.autoSuggestLines,function(a,
b){if(h.length>=c.suggestLength)return console.log("Max suggestions reached"),!1;var d=b.toLowerCase().indexOf(f.toLowerCase());0===d?b.trim()!==f&&h.push(b):0<d&&k.push(b)});h=h.slice(0,c.suggestLength);k=k.slice(0,c.suggestLength-h.length);m=m.concat(h).concat(k);g(m)},focus:function(a,b){return!1},select:function(b,c){console.log("Select");console.log(c.item.value);a.setCurrentLine(c.item.value,e(this).data().index);return!1},position:{my:"right top",at:"right bottom"},delay:0,autoFocus:this.options.autoFocus}).focus(function(){a.checkInterval=
setInterval(function(){a._checkCursorPosition()},100)}).blur(function(){clearInterval(a.checkInterval)})},_setTitleFormat:function(){console.log("Setting Title Format");console.log(this.log);var a=this.log,b=this.options,c=this.nameSpace;e.each(a.sections,function(d,g){if(a.firstLineTitle)switch(b.format){case "html":var f=g[0];b.title.italics&&(f="<i>"+f+"</i>");b.title.underline&&(f="<u>"+f+"</u>");b.title.bold&&(f="<b>"+f+"</b>");e("#"+c+"title"+d).html('<font color="'+b.title.color+'">'+f+"</font>")}})},
_capitalizeFirst:function(a){if(Array.isArray(a)){var b=this;e.each(a,function(c,d){a[c]=b._capitalizeFirst(d)});return a}return a.charAt(0).toUpperCase()+a.slice(1)},refresh:function(){this.$element.text("");this._createTextArea()},addSection:function(a,b){console.log("Adding Section");var c=this.options;if(this.log.firstLineTitle)switch(c.format){case "html":var d=b.shift();c.title.italics&&(d="<i>"+d+"</i>");c.title.underline&&(d="<u>"+d+"</u>");c.title.bold&&(d="<b>"+d+"</b>");this.$worklogBody.append(e("<div>",
{id:this.nameSpace+"title"+a,"class":"editable"}).append(e('<font color="'+c.title.color+'">').html(d)).data({type:"title",index:a,base:this}))}b.length&&(this.$worklogBody.append(e("<div>",{id:this.nameSpace+"section"+a+"bar",css:{"float":"left",width:"13px"}})).append(e("<div>",{id:this.nameSpace+"section"+a,"class":"editable autosuggest",css:{overflow:"hidden"},data:{type:"section",index:a,base:this},html:b.join("<br>")+"<br>"})).append("<br>"),this.refreshSectionBar(a))},refreshSection:function(a){console.log("Refreshing Section");
console.log(this.log.sections[a]);var b=e.extend(!0,{},this.log),c=b.sections[a],d=this.options;if(b.firstLineTitle)switch(d.format){case "html":b=c.shift(),d.title.italics&&(b="<i>"+b+"</i>"),d.title.underline&&(b="<u>"+b+"</u>"),d.title.bold&&(b="<b>"+b+"</b>"),e("#"+this.nameSpace+"title"+a).html(e('<font color="'+d.title.color+'">').html(b))}c.length&&(e("#"+this.nameSpace+"section"+a).html(c.join("<br>")+"<br>"),this.refreshSectionBar(a))},refreshSectionBar:function(a){console.log("Refreshing Section Bar");
var b=this,c=e.extend(!0,{},this.log),d=c.sections[a];e("#"+this.nameSpace+"section"+a+"bar").html("");d=d.length;c.firstLineTitle&&d--;for(c=0;c<d;c++)console.log(parseInt(e("#"+this.nameSpace+"section"+a).css("height"),10)/d),e("#"+this.nameSpace+"section"+a+"bar").append(e("<span>",{"class":"ui-icon ui-icon-close deleteLine",css:{cursor:"pointer",width:"13px",height:parseInt(e("#"+this.nameSpace+"section"+a).css("height"),10)/d},data:{section:a,line:c}}));e("#"+this.nameSpace+"section"+a+"bar").css("height",
e("#"+this.nameSpace+"section"+a).css("height"));e(".deleteLine").off("click").on("click",function(){var a=e(this).data();console.log(a);b.removeLine(a.section,a.line)})},findLineInSection:function(a,b,c,d){console.log("Finding Line In Section");""===a&&(a="^$");var g=new RegExp(a,"i");a=this.log.sections[b];c=null!=c?c:0;d=null!=d?d:a.length;var f=!1;if("string"===typeof c){c=this.findLineInSection(c,b);if(!1===c)return!1;c++}if("string"===typeof d&&(d=this.findLineInSection(d,b),!1===d))return!1;
e.each(a,function(a,b){if(g.test(b)&&a>=c&&a<d)return f=a,!1});return f},findLine:function(a,b,c,d){console.log("Finding Line");var g=this,f=!1;null!=b?f=this.findLineInSection(a,b,c,d):e.each(this.log.sections,function(e,h){f=g.findLineInSection.apply(g,[a,e,c,d]);if(!1!==f)return b=e,!1});return!1!==f?{section:b,line:f}:!1},addLine:function(a,b,c){console.log("Adding Line");a=this._capitalizeFirst(a);b=null!=b?b:this.log.sections.length-1;var d=this.log.sections[b];null==c&&(""===d[d.length-1]&&
d.pop(),c=d.length);Array.isArray(a)?(console.log("Adding Line"),d=d.slice(0,c).concat(a).concat(d.slice(c))):d.splice(c,0,a);this.log.sections[b]=d;this.refreshSection(b);this._trigger("change")},setLine:function(a,b,c){console.log("Setting Line");b=this._capitalizeFirst(b);this.log.sections[c][a]=b;this.refreshSection(c);this._trigger("change")},setCurrentLine:function(a,b){console.log("Setting Current Line");var c=this.currentLine;this.log.firstLineTitle&&c++;this.setLine.apply(this,[c,a,b])},
replace:function(a,b,c,d,g){console.log("Replacing");console.log(b);var f=this.findLine(a,c,d,g),k=this;console.log(f);return!1!==f?(a=new RegExp(a,"i"),console.log(this.log.sections[f.section][f.line]),c=this.log.sections[f.section][f.line],Array.isArray(b)?(a=c.replace(a,b.shift()),this.setLine(f.line,a,f.section),e.each(b,function(a,b){k.addLine(b,f.section)})):(a=c.replace(a,b),this.setLine(f.line,a,f.section)),f):!1},replaceLine:function(a,b,c,d,e){console.log("Replacing Line");a=this.findLine(a,
c,d,e);return!1!==a?(this.setLine(a.line,b,a.section),a):!1},removeLine:function(a,b){console.log("Removing Line");console.log(a);console.log(b);var c=this.log.sections[a].length;this.log.firstLineTitle&&(b++,c--);1<c?this.log.sections[a].splice(b,1):this.log.sections[a][b]="";this.refreshSection(a)},toArray:function(a){console.log("toArray");var b=[],c=e.extend(!0,{},this.log),d=this.options;if(null==a)e.each(c.sections,function(a,g){if(c.firstLineTitle)switch(d.format){case "html":var h=g.shift();
d.title.italics&&(h="<i>"+h+"</i>");d.title.underline&&(h="<u>"+h+"</u>");d.title.bold&&(h="<b>"+h+"</b>");b.push('<font color="'+d.title.color+'">'+h+"</font>")}g.length&&(e.merge(b,g),b.push(""))}),null!=c.sig&&b.push("<b>"+c.sig+"</b>");else{if(c.firstLineTitle)switch(d.format){case "html":var g=c.sections[a].shift();d.title.italics&&(g="<i>"+g+"</i>");d.title.underline&&(g="<u>"+g+"</u>");d.title.bold&&(g="<b>"+g+"</b>");b.push('<font color="'+d.title.color+'">'+g+"</font>")}c.sections[a].length&&
e.merge(b,c.sections[a])}return b},value:function(a){console.log("value");return this.toArray(a).join("\n")},logObj:function(){return this.log}})})(jQuery,window,document);
