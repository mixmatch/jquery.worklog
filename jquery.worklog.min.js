(function(e,k,l,n){e.widget("mixmatch.worklog",{options:{width:"650px",height:"200px",background:"#FFF",format:"plain",title:{color:"#000",bold:!0,underline:!0,italics:!1},fixMinHeight:!1,template:!1,autoSuggest:!1,autoFocus:!1,suggestLength:24},_create:function(){this.nameSpace=this.eventNamespace.replace(/[.]/g,"");this.edited=!1;this.lastWorklogEdit=null;this.inactiveInterval=[];this.autoSuggestLines=[];this.log=e.extend(!0,{},this.options.template);this.currentElem=this.currentLine=this.checkInterval=
null;this.showSuggest=!1;this.lineHeight=15;this.$element=e(this.element);this.element.addClass(this.nameSpace);this.element.addClass(this.widgetName);this._setAutoSuggestLines();this._createTextArea()},_setOption:function(a,c){this._super(a,c)},_setOptions:function(a){this._super(a);this.refresh()},_blur:function(){this.$worklog.blur()},_constrain:function(a){},_destroy:function(){this.element.removeClass(this.nameSpace).text("")},_setAutoSuggestLines:function(){if(this.options.autoSuggest){var a=
this;e.each(this.options.autoSuggest,function(c,b){a.autoSuggestLines.push(b.line)})}},_prevEditable:function(a){var c=e(a).prev(".editable");return c.length?c:e(a).prev().length?this._prevEditable.apply(this,e(a).prev()):e(a).parent().length?this._prevEditable.apply(this,e(a).parent()):!1},_nextEditable:function(a){var c=e(a).next(".editable");return c.length?c:e(a).next().length?this._nextEditable.apply(this,e(a).next()):e(a).parent().length?this._nextEditable.apply(this,e(a).parent()):!1},_getCaretOffsetHTML:function(a){var c=
0,b=a.ownerDocument||a.document,d=b.defaultView||b.parentWindow,g,f=null;"undefined"!=typeof d.getSelection?(g=d.getSelection(),0<g.rangeCount&&(b=d.getSelection().getRangeAt(0),c=b.cloneRange(),c.selectNodeContents(a),c.setEnd(b.endContainer,b.endOffset),f=e("<div>").append(c.cloneContents()).html(),c=f.length)):(g=b.selection)&&"Control"!=g.type&&(c=g.createRange(),b=b.body.createTextRange(),b.moveToElementText(a),b.setEndPoint("EndToEnd",c),c=b.text.length);return c},_checkCursorPosition:function(){var a=
this.focusedElem,c=e(a);if(this.options.autoSuggest&&null!=a){var b=this._getCaretOffsetHTML(a),d=c.html().replace(/(.*)<br>$/i,"$1").split("<br>"),c=c.html().substr(0,b).split("<br>").length-1,b=parseInt(e(a).css("height"),10)/(d.length||1);if(c!==this.currentLine||this.showSuggest)b=parseInt(e(a).css("padding-top"),10)+(c+1)*b,e(a).autocomplete("option","position",{my:"right top",at:"right top+"+b,collision:"none"}).autocomplete("search",d[c]),this.currentLine=c,this.showSuggest=!1}},_createTextArea:function(){var a=
this,c=e.extend(!0,{},this.log||this.options.template),b=this.options;c&&(this.$element.css({width:b.width,height:b.height,background:b.background,"box-sizing":"border-box",padding:"2px","border-radius":"5px",resize:"none"}).append(e("<div>",{id:this.nameSpace+"header",css:{"margin-bottom":"5px",height:"18px",background:"rgba(0,0,0,0.15)","vertical-align":"bottom","border-radius":"4px",position:"relative"}}).append(e("<b>",{text:c.name+" Work Log ",css:{padding:"3px",position:"absolute",bottom:"0",
left:"0"}})).append(e("<div>",{id:this.nameSpace+"headerFormat",css:{"float":"right"}}).append(e("<input>",{id:this.nameSpace+"boldCheck",checked:b.title.bold,type:"checkbox",change:function(){a.options.title.bold=e(this).is(":checked");a._setTitleFormat.apply(a)}})).append(e("<label>",{"for":this.nameSpace+"boldCheck",html:"<b>B</b>"})).append(e("<input>",{id:this.nameSpace+"italicsCheck",checked:b.title.italics,type:"checkbox",change:function(){b.title.italics=e(this).is(":checked");a._setTitleFormat.apply(a)}})).append(e("<label>",
{"for":this.nameSpace+"italicsCheck",html:"<i>I</i>"})).append(e("<input>",{id:this.nameSpace+"underlineCheck",checked:b.title.underline,type:"checkbox",change:function(){b.title.underline=e(this).is(":checked");a._setTitleFormat.apply(a)}})).append(e("<label>",{"for":this.nameSpace+"underlineCheck",html:"<u>U</u>"})).append(e("<input>",{id:this.nameSpace+"titleColor",type:"color",val:b.title.color,css:{width:"16px",height:"16px","margin-left":"10px",padding:"0px 1px"},change:function(){b.title.color=
e(this).val();a._setTitleFormat.apply(a)}})).buttonset())).append(e("<div>",{id:this.nameSpace+"body"})),e(".ui-button","#"+this.nameSpace+"header").css({height:"14px",width:"24px"}),e(".ui-button-text","#"+this.nameSpace+"header").css({padding:"0px 2px",margin:"0px auto","font-size":"0.9em"}),this.$worklogBody=e("#"+this.nameSpace+"body"),e.each(c.sections,function(d,b){a.addSection.apply(a,[d,b])}),null!=c.sig&&a.$worklogBody.append(e("<div>",{id:a.nameSpace+"sig","class":"editable"}).data({type:"sig",
base:a}).html("<b>"+c.sig+"</b>")));e(".editable").attr("contentEditable","true").css("white-space","pre").keydown(function(d){var b=e.ui.keyCode,c;if(d.keyCode==b.UP){if(d.stopImmediatePropagation(),0===a.currentLine||null==a.currentLine)if(d=k.getSelection(),c=l.createRange(),d.getRangeAt(0),d=d.getRangeAt(0).startOffset,b=a._prevEditable.apply(a,[a.focusedElem]))b.focus().css("background-color","rgba( 255, 255, 255, 0.7)"),b="section"===b.data("type")?b.contents().last()[0]:k.getSelection().getRangeAt(0).startContainer,
c.setStart(b,Math.min(d,b.length)),c.collapse(!0),setTimeout(function(){var a=k.getSelection();a.removeAllRanges();a.addRange(c)},1)}else if(d.keyCode==b.DOWN){if(d.stopImmediatePropagation(),d=e(a.focusedElem).html().replace(/(.*)<br>$/i,"$1").split("<br>").length-1,a.currentLine===d||null==a.currentLine)if(d=k.getSelection(),c=l.createRange(),d.getRangeAt(0),d=d.getRangeAt(0).startOffset,b=a._nextEditable.apply(a,[a.focusedElem]))b.focus().css("background-color","rgba( 255, 255, 255, 0.7)"),b=k.getSelection().getRangeAt(0).startContainer,
c.setStart(b,Math.min(d,b.length)),c.collapse(!0),setTimeout(function(){var a=k.getSelection();a.removeAllRanges();a.addRange(c)},1)}else if(d.keyCode==b.ENTER)return d.stopImmediatePropagation(),"section"===e(this).data("type")&&(d=a.log.firstLineTitle?a.log.sections[e(this).data("index")].length-2:a.log.sections[e(this).data("index")].length-1,a.currentLine!==d?(l.execCommand("insertHTML",!1,"<br><br>"),d=k.getSelection(),d.modify("move","backward","line")):l.execCommand("insertHTML",!1,"<br><br>")),
!1}).on("paste",function(a){var b=a.originalEvent;b&&b.clipboardData&&b.clipboardData.getData&&(b=b.clipboardData.getData("text/plain"),a.preventDefault(),a=b.replace(/\r?\n|\r/g,"<br>"),l.execCommand("insertHTML",!1,a))}).on("input",function(){var b=e(this).data();switch(b.type){case "title":a.log.sections[b.index][0]=this.innerText;break;case "section":var c=a._capitalizeFirst(e(this).html().replace(/(.*)<br>$/i,"$1").split("<br>"));a.log.sections[b.index]=a.log.firstLineTitle?[a.log.sections[b.index][0]].concat(c):
c;a.refreshSectionBar(b.index);break;case "sig":a.log.sig=this.innerText}a.showSuggest=!0;a._trigger("change");a._trigger("edit")}).hover(function(b){"mouseenter"===b.type?e(this).css("background-color","rgba( 255, 255, 255, 0.7)"):e(a.focusedElem).attr("id")!=e(this).attr("id")&&e(this).css("background-color","transparent")}).focus(function(){a.showSuggest=!1;e(this).css("background-color","rgba( 255, 255, 255, 0.7)");a.focusedElem=this}).blur(function(){e(this).css("background-color","transparent");
a.currentLine=null;a.focusedElem=null});b.autoSuggest&&e(".autosuggest").autocomplete({source:function(c,g){var f=c.term.trim(),m=[],h=[],k=[];e.each(a.autoSuggestLines,function(a,c){if(h.length>=b.suggestLength)return!1;var d=c.toLowerCase().indexOf(f.toLowerCase());0===d?c.trim()!==f&&h.push(c):0<d&&k.push(c)});h=h.slice(0,b.suggestLength);k=k.slice(0,b.suggestLength-h.length);m=m.concat(h).concat(k);g(m)},focus:function(a,b){return!1},select:function(b,c){a.setCurrentLine(c.item.value,e(this).data().index);
a._trigger("edit");return!1},position:{my:"right top",at:"right bottom"},delay:0,autoFocus:this.options.autoFocus}).focus(function(){a.checkInterval=setInterval(function(){a._checkCursorPosition()},100)}).blur(function(){clearInterval(a.checkInterval)})},_setTitleFormat:function(){var a=this.log,c=this.options,b=this.nameSpace;e.each(a.sections,function(d,g){if(a.firstLineTitle)switch(c.format){case "html":var f=g[0];c.title.italics&&(f="<i>"+f+"</i>");c.title.underline&&(f="<u>"+f+"</u>");c.title.bold&&
(f="<b>"+f+"</b>");e("#"+b+"title"+d).html('<font color="'+c.title.color+'">'+f+"</font>")}})},_capitalizeFirst:function(a){if(Array.isArray(a)){var c=this;e.each(a,function(b,d){a[b]=c._capitalizeFirst(d)});return a}return a.charAt(0).toUpperCase()+a.slice(1)},refresh:function(){this.$element.text("");this._createTextArea()},addSection:function(a,c){var b=this.options;if(this.log.firstLineTitle)switch(b.format){case "html":var d=c.shift();b.title.italics&&(d="<i>"+d+"</i>");b.title.underline&&(d=
"<u>"+d+"</u>");b.title.bold&&(d="<b>"+d+"</b>");this.$worklogBody.append(e("<div>",{id:this.nameSpace+"title"+a,"class":"editable"}).append(e('<font color="'+b.title.color+'">').html(d)).data({type:"title",index:a,base:this}))}c.length&&(this.$worklogBody.append(e("<div>",{id:this.nameSpace+"section"+a+"bar",css:{"float":"left",width:"13px"}})).append(e("<div>",{id:this.nameSpace+"section"+a,"class":"editable autosuggest",css:{overflow:"hidden"},data:{type:"section",index:a,base:this},html:c.join("<br>")+
"<br>"})).append("<br>"),this.refreshSectionBar(a))},refreshSection:function(a){var c=e.extend(!0,{},this.log),b=c.sections[a],d=this.options;if(c.firstLineTitle)switch(d.format){case "html":c=b.shift(),d.title.italics&&(c="<i>"+c+"</i>"),d.title.underline&&(c="<u>"+c+"</u>"),d.title.bold&&(c="<b>"+c+"</b>"),e("#"+this.nameSpace+"title"+a).html(e('<font color="'+d.title.color+'">').html(c))}b.length&&(e("#"+this.nameSpace+"section"+a).html(b.join("<br>")+"<br>"),this.refreshSectionBar(a))},refreshSectionBar:function(a){var c=
this,b=e.extend(!0,{},this.log),d=b.sections[a];e("#"+this.nameSpace+"section"+a+"bar").html("");d=d.length;b.firstLineTitle&&d--;for(b=0;b<d;b++)e("#"+this.nameSpace+"section"+a+"bar").append(e("<span>",{"class":"ui-icon ui-icon-close deleteLine",css:{cursor:"pointer",width:"13px",height:parseInt(e("#"+this.nameSpace+"section"+a).css("height"),10)/d},data:{section:a,line:b}}));e("#"+this.nameSpace+"section"+a+"bar").css("height",e("#"+this.nameSpace+"section"+a).css("height"));e(".deleteLine").off("click").on("click",
function(){var a=e(this).data();c.removeLine(a.section,a.line);c._trigger("edit")})},findLineInSection:function(a,c,b,d){""===a&&(a="^$");var g=new RegExp(a,"i");a=this.log.sections[c];b=null!=b?b:0;d=null!=d?d:a.length;var f=!1;if("string"===typeof b){b=this.findLineInSection(b,c);if(!1===b)return!1;b++}if("string"===typeof d&&(d=this.findLineInSection(d,c),!1===d))return!1;e.each(a,function(a,c){if(g.test(c)&&a>=b&&a<d)return f=a,!1});return f},findLine:function(a,c,b,d){var g=this,f=!1;null!=c?
f=this.findLineInSection(a,c,b,d):e.each(this.log.sections,function(e,h){f=g.findLineInSection.apply(g,[a,e,b,d]);if(!1!==f)return c=e,!1});return!1!==f?{section:c,line:f}:!1},addLine:function(a,c,b){a=this._capitalizeFirst(a);c=null!=c?c:this.log.sections.length-1;var d=this.log.sections[c];null==b&&(""===d[d.length-1]&&d.pop(),b=d.length);Array.isArray(a)?d=d.slice(0,b).concat(a).concat(d.slice(b)):d.splice(b,0,a);this.log.sections[c]=d;this.refreshSection(c);this._trigger("change")},setLine:function(a,
c,b){c=this._capitalizeFirst(c);this.log.sections[b][a]=c;this.refreshSection(b);this._trigger("change")},setCurrentLine:function(a,c){var b=this.currentLine;this.log.firstLineTitle&&b++;this.setLine.apply(this,[b,a,c])},replace:function(a,c,b,d,g){var f=this.findLine(a,b,d,g),k=this;return!1!==f?(a=new RegExp(a,"i"),b=this.log.sections[f.section][f.line],Array.isArray(c)?(a=b.replace(a,c.shift()),this.setLine(f.line,a,f.section),e.each(c,function(a,b){k.addLine(b,f.section)})):(a=b.replace(a,c),
this.setLine(f.line,a,f.section)),f):!1},replaceLine:function(a,c,b,d,e){a=this.findLine(a,b,d,e);return!1!==a?(this.setLine(a.line,c,a.section),a):!1},removeLine:function(a,c){var b=this.log.sections[a].length;this.log.firstLineTitle&&(c++,b--);1<b?this.log.sections[a].splice(c,1):this.log.sections[a][c]="";this.refreshSection(a)},toArray:function(a){var c=[],b=e.extend(!0,{},this.log),d=this.options;if(null==a)e.each(b.sections,function(a,g){if(b.firstLineTitle)switch(d.format){case "html":var h=
g.shift();d.title.italics&&(h="<i>"+h+"</i>");d.title.underline&&(h="<u>"+h+"</u>");d.title.bold&&(h="<b>"+h+"</b>");c.push('<font color="'+d.title.color+'">'+h+"</font>")}g.length&&(e.merge(c,g),c.push(""))}),null!=b.sig&&c.push("<b>"+b.sig+"</b>");else{if(b.firstLineTitle)switch(d.format){case "html":var g=b.sections[a].shift();d.title.italics&&(g="<i>"+g+"</i>");d.title.underline&&(g="<u>"+g+"</u>");d.title.bold&&(g="<b>"+g+"</b>");c.push('<font color="'+d.title.color+'">'+g+"</font>")}b.sections[a].length&&
e.merge(c,b.sections[a])}return c},value:function(a){return this.toArray(a).join("\n")},logObj:function(){return this.log}})})(jQuery,window,document);
