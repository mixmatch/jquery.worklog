(function(d,c,a,e){var b=false;d.widget("mixmatch.worklog",{options:{width:"650px",height:"200px",background:"#FFF",format:"plain",title:{color:"#000",bold:true,underline:true,italics:false},fixMinHeight:false,template:false,autoSuggest:false,autoFocus:false,suggestLength:24,editable:true},_create:function(){this.nameSpace=this.eventNamespace.replace(/[.]/g,"");this.edited=false;this.lastWorklogEdit=null;this.inactiveInterval=[];this.autoSuggestLines=[];this.log=d.extend(true,{},this.options.template);this.checkInterval=null;this.currentLine=null;this.currentElem=null;this.showSuggest=false;this.lineHeight=15;this.$element=d(this.element);this.element.addClass(this.nameSpace);this.element.addClass(this.widgetName);this._setAutoSuggestLines();this._createTextArea()},_setOption:function(g,h){this._super(g,h)},_setOptions:function(g){this._super(g);this.refresh()},_blur:function(){this.$worklog.blur()},_constrain:function(g){},_destroy:function(){this.element.removeClass(this.nameSpace).text("");d(this.$worklogBody).off()},_setAutoSuggestLines:function(){if(b){console.log("setAutoSuggestLines")}if(this.options.autoSuggest){var g=this;d.each(this.options.autoSuggest,function(h,i){g.autoSuggestLines.push(i.line)})}},_prevEditable:function(h){var g=d(h).prev(".editable");if(g.length){return g}else{if(d(h).prev().length){return this._prevEditable.apply(this,d(h).prev())}else{if(d(h).parent().length){return this._prevEditable.apply(this,d(h).parent())}else{return false}}}},_nextEditable:function(h){var g=d(h).next(".editable");if(g.length){return g}else{if(d(h).next().length){return this._nextEditable.apply(this,d(h).next())}else{if(d(h).parent().length){return this._nextEditable.apply(this,d(h).parent())}else{return false}}}},_getCaretOffsetHTML:function(i){var l=0;var m=i.ownerDocument||i.document;var k=m.defaultView||m.parentWindow;var g;var h=null;if(typeof k.getSelection!="undefined"){g=k.getSelection();if(g.rangeCount>0){var j=k.getSelection().getRangeAt(0);var n=j.cloneRange();n.selectNodeContents(i);n.setEnd(j.endContainer,j.endOffset);h=d("<div>").append(n.cloneContents()).html();l=h.length}}else{if((g=m.selection)&&g.type!="Control"){var p=g.createRange();var o=m.body.createTextRange();o.moveToElementText(i);o.setEndPoint("EndToEnd",p);l=o.text.length}}return l},_checkCursorPosition:function(){var m=this.focusedElem;var i=d(m);if(this.options.autoSuggest&&m!=null){var l=this._getCaretOffsetHTML(m);var h=i.html().replace(/(.*)<br>$/i,"$1").split("<br>");var g=i.html().substr(0,l).split("<br>").length-1;var k=parseInt(d(m).css("height"),10)/(h.length||1);var j;if(g!==this.currentLine||this.showSuggest){j=parseInt(d(m).css("padding-top"),10)+((g+1)*k);d(m).autocomplete("option","position",{my:"right top",at:"right top+"+j,collision:"none"}).autocomplete("search",h[g]);this.currentLine=g;this.showSuggest=false}}},_upKey:function(k,l){k.stopImmediatePropagation();var i,g,m,j,h;if(l.currentLine===0||l.currentLine==null){i=c.getSelection();g=a.createRange();m=i.getRangeAt(0).startOffset;j=l._prevEditable.apply(l,[l.focusedElem]);if(j){j.focus().css("background-color","rgba( 255, 255, 255, 0.7)");if(j.hasClass("section")){h=j.contents().last()[0]}else{h=c.getSelection().getRangeAt(0).startContainer}g.setStart(h,Math.min(m,h.length));g.collapse(true);setTimeout(function(){var n=c.getSelection();n.removeAllRanges();n.addRange(g)},1)}}},_downKey:function(l,m){l.stopImmediatePropagation();var g,k,h,n,j,i;g=d(m.focusedElem).html().replace(/(.*)<br>$/i,"$1").split("<br>").length-1;if(m.currentLine===g||m.currentLine==null){k=c.getSelection();h=a.createRange();k.getRangeAt(0);n=k.getRangeAt(0).startOffset;j=m._nextEditable.apply(m,[m.focusedElem]);if(j){j.focus().css("background-color","rgba( 255, 255, 255, 0.7)");i=c.getSelection().getRangeAt(0).startContainer;h.setStart(i,Math.min(n,i.length));h.collapse(true);setTimeout(function(){var o=c.getSelection();o.removeAllRanges();o.addRange(h)},1)}}},_addAutoSuggest:function(i){var h=this;var g=this.options;d(i).keydown(function(j){var k=d.ui.keyCode;if(!g.autoFocus){if(j.keyCode==k.UP){h._upKey(j,h)}else{if(j.keyCode==k.DOWN){h._downKey(j,h)}}}else{if(d(".ui-autocomplete:visible").length&&j.keyCode==k.ENTER){j.preventDefault();j.stopPropagation();return false}}}).autocomplete({source:function(n,k){var l=n.term.trim();var j=[];var p=[];var m=[];var o;d.each(h.autoSuggestLines,function(q,r){if(p.length>=g.suggestLength){return false}o=r.toLowerCase().indexOf(l.toLowerCase());if(0===o){if(r.trim()!==l){p.push(r)}}else{if(0<o){m.push(r)}}});p=p.slice(0,g.suggestLength);m=m.slice(0,g.suggestLength-p.length);j=j.concat(p).concat(m);k(j)},focus:function(j,k){return false},select:function(j,k){h.setCurrentLine(k.item.value,d(".section").index(d(this)));h._trigger("edit");return false},position:{my:"right top",at:"right bottom"},delay:0,autoFocus:this.options.autoFocus}).focus(function(){h.checkInterval=setInterval(function(){h._checkCursorPosition()},100)}).blur(function(){clearInterval(h.checkInterval)})},_createTextArea:function(){if(b){console.log("createTextArea")}var l=this;var i="";var k=this.log||this.options.template;var j=this.options;if(j.format==="textarea"){console.log(k.sections);var h=[];d.each(k.sections,function(m,n){h=h.concat(n);if(m+1!==k.sections.length){h=h.concat("")}});k.sections=[h];console.log(k)}var g=d.extend(true,{},k);if(b){console.log(this);console.log(g)}if(g){this.$element.css({width:j.width,height:j.height,background:j.background,"box-sizing":"border-box",padding:"2px","border-radius":"5px",resize:"none"}).append(d("<div>",{id:this.nameSpace+"header",css:{"margin-bottom":"5px",height:"18px",background:"rgba(0,0,0,0.15)","vertical-align":"bottom","border-radius":"4px",position:"relative"}}).append(d("<b>",{text:g.name+" Work Log ",css:{padding:"3px",position:"absolute",bottom:"0",left:"0"}})).append(d("<button>",{id:this.nameSpace+"addSectionBtn",text:"Add Section",css:{"float":"right"},type:"button",click:function(){l.addSection(["Section Header","Section Lines"]);l._trigger("edit")}})).append(d("<div>",{id:this.nameSpace+"headerFormat",css:{"float":"right"}}).append(d("<select>",{id:this.nameSpace+"format",css:{"margin-right":"5px","vertical-align":"middle",border:"0px",height:"16px"},html:'<option value="html">HTML</option><option value="plain">Plain text</option><option value="textarea">Text box</option>',change:function(){if(j.format==="textarea"){l.log.sections=l.value(0).split(/\n\n\b/);d.each(l.log.sections,function(m,n){l.log.sections[m]=n.split("\n")})}j.format=d(this).val();l.refresh()}})).append(d("<input>",{id:this.nameSpace+"boldCheck",checked:j.title.bold,type:"checkbox",change:function(){l.options.title.bold=d(this).is(":checked");l._setTitleFormat.apply(l)}})).append(d("<label>",{"for":this.nameSpace+"boldCheck",html:"<b>B</b>"})).append(d("<input>",{id:this.nameSpace+"italicsCheck",checked:j.title.italics,type:"checkbox",change:function(){j.title.italics=d(this).is(":checked");l._setTitleFormat.apply(l)}})).append(d("<label>",{"for":this.nameSpace+"italicsCheck",html:"<i>I</i>"})).append(d("<input>",{id:this.nameSpace+"underlineCheck",checked:j.title.underline,type:"checkbox",change:function(){j.title.underline=d(this).is(":checked");l._setTitleFormat.apply(l)}})).append(d("<label>",{"for":this.nameSpace+"underlineCheck",html:"<u>U</u>"})).append(d("<input>",{id:this.nameSpace+"titleColor",type:"color",val:j.title.color,css:{width:"16px",height:"16px","margin-left":"10px",padding:"0px 1px"},change:function(){j.title.color=d(this).val();l._setTitleFormat.apply(l)}})).buttonset())).append(d("<div>",{id:this.nameSpace+"body"}));d("#"+this.nameSpace+"addSectionBtn").button();d("#"+this.nameSpace+"format").val(j.format);d(".ui-button","#"+this.nameSpace+"header").not(':contains("Add Section")').css({height:"14px",width:"24px"});d(".ui-button-text","#"+this.nameSpace+"header").css({padding:"0px 2px",margin:"0px auto","font-size":"0.9em"});this.$worklogBody=d("#"+this.nameSpace+"body");d.each(g.sections,function(m,n){l.addSection.apply(l,[n,m])});if(g.sig!=null){l.$worklogBody.append(d("<div>",{id:l.nameSpace+"sig","class":this.nameSpace+" sig"+(l.options.editable?" editable":""),contentEditable:l.options.editable}).html("<b>"+g.sig+"</b>"))}}d(this.$worklogBody).on("keydown",".editable",function(o){var q=d.ui.keyCode;var p;var n;var m;console.log(d(".ui-autocomplete:visible").length);console.log(j.autoFocus);if(d(".ui-autocomplete:visible").length&&j.autoFocus){}else{if(o.keyCode==q.UP){l._upKey(o,l)}else{if(o.keyCode==q.DOWN){l._downKey(o,l)}else{if(o.keyCode==q.ENTER){o.stopImmediatePropagation();if(d(this).hasClass("section")){p=d(".section").index(d(this));if(l.log.firstLineTitle){m=l.log.sections[p].length-2}else{m=l.log.sections[p].length-1}if(l.currentLine!==m){a.execCommand("insertHTML",false,"<br><br>");n=c.getSelection();n.modify("move","backward","line")}else{a.execCommand("insertHTML",false,"<br><br>")}}return false}}}}}).on("paste",".editable",function(n){var o=n.originalEvent;var m;var p;if(o&&o.clipboardData&&o.clipboardData.getData){m=o.clipboardData.getData("text/plain");n.preventDefault();p=m.replace(/\r?\n|\r/g,"<br>");a.execCommand("insertHTML",false,p)}}).on("input",".editable",function(){var m;if(d(this).hasClass("title")){m=d(".title").index(d(this));l.log.sections[m][0]=this.innerText}else{if(d(this).hasClass("section")){m=d(".section").index(d(this));var n=l._capitalizeFirst(d(this).html().replace(/(.*)<br>$/i,"$1").split("<br>"));if(l.log.firstLineTitle){l.log.sections[m]=[l.log.sections[m][0]].concat(n)}else{l.log.sections[m]=n}l.refreshSectionBar(m)}else{if(d(this).hasClass("sig")){l.log.sig=this.innerText}}}l.showSuggest=true;l._trigger("change");l._trigger("edit")}).on("mouseenter mouseleave",".editable, textarea",function(m){if(m.type==="mouseenter"){d(this).css("background-color","rgba( 255, 255, 255, 0.7)")}else{if(this!=l.focusedElem){d(this).css("background-color","transparent")}}}).on("focus",".editable, textarea",function(){l.showSuggest=false;d(this).css("background-color","rgba( 255, 255, 255, 0.7)");l.focusedElem=this}).on("blur",".editable, textarea",function(){d(this).css("background-color","transparent");l.currentLine=null;l.focusedElem=null}).on("mouseenter mouseleave",".ui-icon-trash",function(m){m.stopPropagation();if(m.type==="mouseenter"){d(this).parent().css("background-color","rgba(255, 194, 194, 0.7)");d(this).parent().next().css("background-color","rgba(255, 194, 194, 0.7)");d(this).parent().next().next().css("background-color","rgba(255, 194, 194, 0.7)")}else{d(this).parent().css("background-color","transparent");d(this).parent().next().css("background-color","transparent");d(this).parent().next().next().css("background-color","transparent")}}).on("click",".ui-icon-trash",function(m){m.stopImmediatePropagation();sectionNum=d(".title").index(d(this).parent());l.removeSection(sectionNum)}).on("input","textarea",function(m){l.log.sections[0]=d(this).val().split("\n");d(this).height(0);d(this).height(d(this).prop("scrollHeight")-4)})},_formatTitleHTML:function(h,g){if(g.italics){h="<i>"+h+"</i>"}if(g.underline){h="<u>"+h+"</u>"}if(g.bold){h="<b>"+h+"</b>"}return'<font color="'+g.color+'">'+h+'</font><span class="'+this.nameSpace+' ui-icon ui-icon-trash" style="cursor: pointer; float: right;"></span>'},_setTitleFormat:function(){var i=this;var g=this.log;var h=this.options;d.each(g.sections,function(k,m){if(g.firstLineTitle){switch(h.format){case"html":var j=m[0];var l=i._formatTitleHTML(j,h.title);d(".title:eq("+k+")").html(l);break;case"plain":break}}})},_capitalizeFirst:function(h){if(Array.isArray(h)){var g=this;d.each(h,function(i,j){h[i]=g._capitalizeFirst(j)});return h}else{return h.charAt(0).toUpperCase()+h.slice(1)}},refresh:function(){this.$element.text("");this._createTextArea()},addSection:function(m,k){if(b){console.log("Adding Section")}if(k==null){k=this.log.sections.length}this.log.sections[k]=m.slice();var i=this.log;var j=this.options;if(i.firstLineTitle){switch(j.format){case"html":var h=m.shift();$title=d("<div>",{"class":this.nameSpace+" title"+(this.options.editable?" editable":""),contentEditable:this.options.editable}).append(this._formatTitleHTML(h,j.title));if(d(".sig").length){d(".sig").before($title)}else{this.$worklogBody.append($title)}break;case"plain":break}}if(m.length){switch(j.format){case"html":case"plain":var g=d("<div>",{"class":this.nameSpace+" sectionBar",css:{"float":"left",width:"13px"}});var l=d("<div>",{"class":this.nameSpace+" autosuggest section"+(this.options.editable?" editable":""),contentEditable:this.options.editable,css:{overflow:"hidden","white-space":"pre"},html:m.join("<br>")+"<br>"});break;case"textarea":var g=d("<div>");var l=d("<textarea>",{"class":this.nameSpace+" section",css:{overflow:"hidden","white-space":"pre",height:"auto",width:"99%",border:"none","background-color":"transparent"},html:m.join("\n")});break}if(d(".sig").length){d(".sig").before(g).before(l).before("<br>")}else{this.$worklogBody.append(g).append(l).append("<br>")}if(j.format==="textarea"){l.height(l.prop("scrollHeight")-4);setTimeout(function(){l.height(l.prop("scrollHeight")-4)},1000)}if(j.autoSuggest&&j.format!=="textarea"){this._addAutoSuggest(l)}if(this.options.editable){this.refreshSectionBar(k)}else{d("#"+this.nameSpace+"section"+k+"bar").hide()}}},removeSection:function(g){this.log.sections.splice(g,1);if(this.log.firstLineTitle&&this.options.format==="html"){d(".title")[g].remove()}d(d(".section")[g]).next().remove();d(".section")[g].remove();d(".sectionBar")[g].remove()},refreshSection:function(k){var h=d.extend(true,{},this.log);var j=h.sections[k];var g;var i=this.options;if(!j){return false}if(h.firstLineTitle){switch(i.format){case"html":h=j.shift();d(".title:eq("+k+")").html(this._formatTitleHTML(h,i.title));break;case"plain":break}}if(j.length){g=d(".section:eq("+k+")");if(i.format!=="textarea"){g.html(j.join("<br>")+"<br>");this.refreshSectionBar(k)}else{g.val(j.join("\n"));g.height(g.prop("scrollHeight")-4)}}},refreshSectionBar:function(k){var i=this;if(this.log.sections[k]==null){return false}if(d(".section:eq("+k+")").css("height")==="0px"){setTimeout(function(){i.refreshSectionBar(k)},1000);return false}var g=d.extend(true,{},this.log);var j=g.sections[k];d(".sectionBar:eq("+k+")").html("");sectionLength=j.length;if(g.firstLineTitle&&this.options.format==="html"){sectionLength--}var h=parseInt(d(".section:eq("+k+")").css("height"),10)/sectionLength;for(f=0;f<sectionLength;f++){d(".sectionBar:eq("+k+")").append(d("<span>",{"class":i.nameSpace+" ui-icon ui-icon-close deleteLine",css:{cursor:"pointer",width:"13px",height:h+"px"}}))}d(".sectionBar:eq("+k+")").css("height",d(".section:eq("+k+")").css("height"));d(".deleteLine").off("click").on("click",function(){var l=d(".deleteLine",d(this).parent()).index(d(this));var m=d(".sectionBar").index(d(this).parent());i.removeLine(m,l);i._trigger("edit")})},findLineInSection:function(g,m,l,i){if(b){console.log("Finding Line In Section")}if(g===""){g="^$"}var h=new RegExp(g,"i");var j=this.log.sections[m];if(l==null){l=0}if(i==null){i=j.length}var k=false;if(typeof l==="string"){l=this.findLineInSection(l,m);if(l===false){return false}l++}if(typeof i==="string"){i=this.findLineInSection(i,m);if(i===false){return false}}d.each(j,function(n,o){if((h.test(o))&&(n>=l)&&(n<i)){k=n;return false}});return k},findLine:function(h,m,l,j){if(b){console.log("Finding Line")}var i=this;var g=this.log;var k=false;if(m!=null){k=this.findLineInSection(h,m,l,j)}else{d.each(this.log.sections,function(n,o){k=i.findLineInSection.apply(i,[h,n,l,j]);if(k!==false){m=n;return false}})}return k!==false?{section:m,line:k}:false},addLine:function(g,j,i){if(b){console.log("Adding Line")}g=this._capitalizeFirst(g);if(j==null){j=this.log.sections.length-1}var h=this.log.sections[j];if(i==null){if(h[h.length-1]===""){h.pop()}i=h.length}if(Array.isArray(g)){if(b){console.log("Adding Line")}h=h.slice(0,i).concat(g).concat(h.slice(i))}else{h.splice(i,0,g)}this.log.sections[j]=h;this.refreshSection(j);this._trigger("change")},setLine:function(i,g,h){if(b){console.log("Setting Line")}g=this._capitalizeFirst(g);this.log.sections[h][i]=g;this.refreshSection(h);this._trigger("change")},setCurrentLine:function(g,h){if(b){console.log("Setting Current Line")}var i=this.currentLine;if(this.log.firstLineTitle){i++}this.setLine.apply(this,[i,g,h])},replace:function(i,g,m,o,k){if(b){console.log("Replacing");console.log(g)}var l=this.findLine(i,m,o,k);var j;var h=this;if(b){console.log(l)}if(l!==false){var p=new RegExp(i,"i");if(b){console.log(this.log.sections[l.section][l.line])}var n=this.log.sections[l.section][l.line];if(Array.isArray(g)){j=n.replace(p,g.shift());this.setLine(l.line,j,l.section);d.each(g,function(q,r){h.addLine(r,l.section)})}else{j=n.replace(p,g);this.setLine(l.line,j,l.section)}return l}else{return false}},replaceLine:function(g,h,l,k,i){if(b){console.log("Replacing Line")}var j=this.findLine(g,l,k,i);if(j!==false){this.setLine(j.line,h,j.section);return j}else{return false}},removeLine:function(i,h){if(b){console.log("Removing Line");console.log(i);console.log(h)}var g=this.log.sections[i].length;if(this.log.firstLineTitle&&this.options.format==="html"){h++;g--}if(g>1){this.log.sections[i].splice(h,1)}else{if(!this.log.firstLineTitle||this.options.format==="plain"){this.removeSection(i)}else{this.log.sections[i][h]=""}}this.refreshSection(i)},toArray:function(k){if(b){console.log("toArray")}var h=[];var g=d.extend(true,{},this.log);var j=this.options;if(k==null){d.each(g.sections,function(m,n){if(g.firstLineTitle){switch(j.format){case"html":var l=n.shift();if(j.title.italics){l="<i>"+l+"</i>"}if(j.title.underline){l="<u>"+l+"</u>"}if(j.title.bold){l="<b>"+l+"</b>"}h.push('<font color="'+j.title.color+'">'+l+"</font>");break;case"plain":break}}if(n.length){d.merge(h,n);h.push("")}});if(g.sig!=null){h.push("<b>"+g.sig+"</b>")}}else{if(g.firstLineTitle){switch(j.format){case"html":var i=g.sections[k].shift();if(j.title.italics){i="<i>"+i+"</i>"}if(j.title.underline){i="<u>"+i+"</u>"}if(j.title.bold){i="<b>"+i+"</b>"}h.push('<font color="'+j.title.color+'">'+i+"</font>");break;case"plain":break}}if(g.sections[k].length){d.merge(h,g.sections[k])}}return h},value:function(g){if(b){console.log("value")}return this.toArray(g).join("\n")},logObj:function(){return this.log}})})(jQuery,window,document);